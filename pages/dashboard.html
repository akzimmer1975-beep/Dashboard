<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>BR Wahlen 2026 ‚Äì Dashboard</title>

<link rel="stylesheet" href="../global.css">
<link rel="stylesheet" href="../dashboard.css">

<style>
#back-button{
  position:absolute;
  top:20px;
  left:20px;
  z-index:1000;
}

#back-button button{
  background:white;
  color:#228B22;
  font-weight:bold;
}

.toolbar{
  margin-bottom:10px;
}
</style>
</head>

<body>

<div id="back-button">
  <button onclick="window.location.href='../index.html'">‚Üê Startseite</button>
</div>

<h1>BR-Wahl ‚Äì Dashboard</h1>

<div class="toolbar">
  <label>
    Bezirk:
    <select id="bezirkFilter" onchange="applyFilter()">
      <option value="">Alle Bezirke</option>
    </select>
  </label>
</div>

<!-- SUMMARY -->
<div id="summary" class="summary-bar">
  <span id="sumText"></span>
  <div class="summary-buttons">
    <button class="sum-btn gruen" onclick="toggleAmpel('gruen')">üü¢</button>
    <button class="sum-btn gelb" onclick="toggleAmpel('gelb')">üü°</button>
    <button class="sum-btn rot" onclick="toggleAmpel('rot')">üî¥</button>
    <button class="sum-btn clear" onclick="clearFilter()">‚úñ</button>
  </div>
</div>

<div id="overlay">
  <div class="spinner"></div>
  <div>Lade Statusdaten‚Ä¶</div>
</div>

<div id="grid"></div>

<script>
let alleBetriebe = [];
let ampelFilter = [];   // üî¥üü°üü¢ Multi-State

// ---------------- INIT ----------------
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("overlay").style.display = "flex";
  loadDataFromLocalStorage();
  fillBezirkFilter();
  renderDashboard();
  document.getElementById("overlay").style.display = "none";
});

// ---------------- DATA ----------------
function loadDataFromLocalStorage() {
  const data = localStorage.getItem("apiData");
  alleBetriebe = data ? JSON.parse(data) : [];
}

// ---------------- FILTER ----------------
function fillBezirkFilter() {
  const select = document.getElementById("bezirkFilter");
  select.innerHTML = `<option value="">Alle Bezirke</option>`;
  [...new Set(alleBetriebe.map(b => b.bezirk))]
    .sort()
    .forEach(b => {
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      select.appendChild(opt);
    });
}

function applyFilter(){
  renderDashboard();
}

function toggleAmpel(farbe){
  if(ampelFilter.includes(farbe)){
    ampelFilter = ampelFilter.filter(f => f !== farbe);
  } else {
    ampelFilter.push(farbe);
  }
  renderDashboard();
}

function clearFilter(){
  ampelFilter = [];
  document.getElementById("bezirkFilter").value = "";
  renderDashboard();
}

// ---------------- RENDER ----------------
function renderDashboard() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  const bezirkFilter = document.getElementById("bezirkFilter").value;
  let filtered = alleBetriebe;

  if (bezirkFilter) {
    filtered = filtered.filter(b => b.bezirk === bezirkFilter);
  }

  if (ampelFilter.length > 0) {
    filtered = filtered.filter(b => ampelFilter.includes(b.ampel));
  }

  let lastBezirk = null;
  const fragment = document.createDocumentFragment();

  filtered.forEach(b => {

    if (b.bezirk !== lastBezirk) {
      const header = document.createElement("div");
      header.className = "bezirk-header";
      header.textContent = b.bezirk;
      fragment.appendChild(header);
      lastBezirk = b.bezirk;
    }

    const card = document.createElement("div");
    card.className = "card-row";

    // Ampel Anzeige (kein Filter!)
    const ampBtn = document.createElement("button");
    ampBtn.className = `ampel-btn ${b.ampel}`;
    ampBtn.textContent =
      b.ampel === "gruen" ? "üü¢" :
      b.ampel === "gelb" ? "üü°" :
      b.ampel === "rot"  ? "üî¥" : "";

    // BKZ
    const bkzLink = document.createElement("a");
    bkzLink.href = `../marker.html?bezirk=${encodeURIComponent(b.bezirk)}&bkz=${encodeURIComponent(b.bkz)}`;
    bkzLink.textContent = `BKZ ${b.bkz}`;
    bkzLink.target = "_blank";
    bkzLink.className = "bkz-link";

    // Info
    const info = document.createElement("div");
    info.className = "card-info";
    info.innerHTML = `(${b.bezirk}) ‚Äì Dateien: <b>${b.files}</b>`;

    card.appendChild(ampBtn);
    card.appendChild(bkzLink);
    card.appendChild(info);

    fragment.appendChild(card);
  });

  grid.appendChild(fragment);

  // Summary
  const el = document.getElementById("sumText");
  const g = filtered.filter(b => b.ampel === "gruen").length;
  const y = filtered.filter(b => b.ampel === "gelb").length;
  const r = filtered.filter(b => b.ampel === "rot").length;
  el.textContent = `Gesamt: ${filtered.length} | üü¢ ${g} | üü° ${y} | üî¥ ${r}`;

  updateSummaryUI();
}

// ---------------- UI STATE ----------------
function updateSummaryUI(){
  document.querySelectorAll(".sum-btn").forEach(btn=>{
    btn.classList.remove("active");
  });

  ampelFilter.forEach(f=>{
    const btn = document.querySelector(`.sum-btn.${f}`);
    if(btn) btn.classList.add("active");
  });
}
</script>

</body>
</html>
