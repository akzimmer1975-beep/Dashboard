<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>BR Wahlen 2026 ‚Äì Dashboard</title>
<link rel="stylesheet" href="../global.css">
<link rel="stylesheet" href="../dashboard.css">
<style>
  /* Overlay w√§hrend Rendern */
  #overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    color: white;
    font-size: 1.5em;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    display: none;
  }

  .bezirk-header {
    margin-top: 20px;
    font-weight: bold;
    font-size: 1.2em;
  }

  .card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    margin: 5px 0;
    background: #f5f5f5;
    border-radius: 6px;
    color: black;
  }

  .ampel-btn {
    border: none;
    font-size: 1.2em;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
  }

  .ampel-btn.gruen { background-color: #4CAF50; color: white; }
  .ampel-btn.gelb { background-color: #FFC107; color: white; }
  .ampel-btn.rot { background-color: #F44336; color: white; }

  .bkz-link { text-decoration: none; color: #228B22; font-weight: bold; }

  #summary { margin-top: 15px; font-weight: bold; }

  #back-button {
    position: absolute;
    top: 20px; left: 20px;
  }

  #back-button button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    background-color: white;
    color: #228B22;
  }

  #back-button button:hover {
    background-color: #f0f0f0;
  }
</style>
</head>
<body>

<!-- Zur√ºck-Button -->
<div id="back-button">
  <button onclick="window.location.href='../index.html'">‚Üê Startseite</button>
</div>

<h1>BR-Wahl ‚Äì Dashboard</h1>

<div class="toolbar">
  <label>
    Bezirk:
    <select id="bezirkFilter" onchange="applyFilter()">
      <option value="">Alle Bezirke</option>
    </select>
  </label>
</div>

<div id="overlay">Lade Statusdaten‚Ä¶</div>

<div id="summary"></div>
<div id="grid"></div>

<script>
let alleBetriebe = [];

// -----------------------------
// INIT
// -----------------------------
document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("overlay");
  overlay.style.display = "block"; // Overlay w√§hrend Laden

  loadDataFromLocalStorage();
  fillBezirkFilter();
  renderDashboard();

  overlay.style.display = "none"; // Overlay ausblenden
});

// -----------------------------
// DATEN AUS LOCALSTORAGE LADEN
// -----------------------------
function loadDataFromLocalStorage() {
  const data = localStorage.getItem("apiData");
  alleBetriebe = data ? JSON.parse(data) : [];
}

// -----------------------------
// BEZIRK-FILTER F√úLLEN
// -----------------------------
function fillBezirkFilter() {
  const select = document.getElementById("bezirkFilter");
  select.innerHTML = `<option value="">Alle Bezirke</option>`;
  [...new Set(alleBetriebe.map(b => b.bezirk))]
    .sort()
    .forEach(b => {
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      select.appendChild(opt);
    });
}

// -----------------------------
// DASHBOARD RENDER
// -----------------------------
function renderDashboard() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  const bezirkFilter = document.getElementById("bezirkFilter").value;
  const filtered = bezirkFilter ? alleBetriebe.filter(b => b.bezirk === bezirkFilter) : alleBetriebe;

  let lastBezirk = null;
  const fragment = document.createDocumentFragment();

  filtered.forEach(b => {
    if (b.bezirk !== lastBezirk) {
      const header = document.createElement("div");
      header.className = "bezirk-header";
      header.textContent = b.bezirk;
      fragment.appendChild(header);
      lastBezirk = b.bezirk;
    }

    const card = document.createElement("div");
    card.className = "card";

    // Ampel Button
    const ampBtn = document.createElement("button");
    ampBtn.className = `ampel-btn ${b.ampel}`;
    ampBtn.textContent =
      b.ampel === "gruen" ? "üü¢" :
      b.ampel === "gelb" ? "üü°" :
      b.ampel === "rot" ? "üî¥" : "";
    ampBtn.title = b.ampel.toUpperCase();
    ampBtn.onclick = () => goToIndex(b.ampel, b.bezirk);

    // BKZ-Link
    const bkzLink = document.createElement("a");
    bkzLink.href = `../marker.html?bezirk=${encodeURIComponent(b.bezirk)}&bkz=${encodeURIComponent(b.bkz)}`;
    bkzLink.textContent = `BKZ ${b.bkz}`;
    bkzLink.target = "_blank";
    bkzLink.className = "bkz-link";

    // Info
    const info = document.createElement("div");
    info.className = "card-info";
    info.innerHTML = `(${b.bezirk}) ‚Äì Dateien: <b>${b.files}</b>`;

    card.appendChild(ampBtn);
    card.appendChild(bkzLink);
    card.appendChild(info);

    fragment.appendChild(card);
  });

  grid.appendChild(fragment);

  // Summary
  const el = document.getElementById("summary");
  const g = filtered.filter(b => b.ampel === "gruen").length;
  const y = filtered.filter(b => b.ampel === "gelb").length;
  const r = filtered.filter(b => b.ampel === "rot").length;
  el.textContent = `Gesamt: ${filtered.length} | üü¢ ${g} | üü° ${y} | üî¥ ${r}`;
}

// -----------------------------
// FILTER-FUNKTIONEN
// -----------------------------
function applyFilter() {
  renderDashboard();
}

function setAmpelFilter(farbe) {
  const select = document.getElementById("bezirkFilter");
  const bezirk = select.value;
  goToIndex(farbe, bezirk);
}

// -----------------------------
// WEITERLEITUNG ZUR DASHBOARD-SEITE (Index)
//-----------------------------
function goToIndex(ampel, bezirk) {
  const params = new URLSearchParams();
  if (ampel && ampel !== "alle") params.set("ampel", ampel);
  if (bezirk) params.set("bezirk", bezirk);
  window.location.href = `../pages/dashboard.html?${params.toString()}`;
}
</script>

</body>
</html>
